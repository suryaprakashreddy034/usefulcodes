-- Databricks notebook source
-- MAGIC %md #Environment Parametrization

-- COMMAND ----------

-- MAGIC %python
-- MAGIC workspace = spark.conf.get("spark.databricks.workspaceUrl").split('.')[0].split('-')[1]
-- MAGIC
-- MAGIC if workspace == "usprd":
-- MAGIC 	S3_ENV_PATH = "s3://tpc-aws-ted-prd-edpp-hub-gms-us-east-1"
-- MAGIC 	TIDAL_JOB_ID = "79892" 
-- MAGIC elif workspace == "ustst":
-- MAGIC 	S3_ENV_PATH = "s3://tpc-aws-ted-tst-edpp-hub-gms-us-east-1"
-- MAGIC 	TIDAL_JOB_ID = "100997" 
-- MAGIC elif workspace == "usdev":
-- MAGIC 	S3_ENV_PATH = "s3://tpc-aws-ted-dev-edpp-hub-gms-us-east-1"
-- MAGIC 	TIDAL_JOB_ID = "153595" 
-- MAGIC
-- MAGIC spark.conf.set("c.S3_ENV_PATH", S3_ENV_PATH)
-- MAGIC spark.conf.set("c.TIDAL_JOB_ID", TIDAL_JOB_ID)
-- MAGIC
-- MAGIC bucket_name = S3_ENV_PATH[5:] # remove 's3://' part
-- MAGIC
-- MAGIC print("Workspace: " + workspace, "\n ","S3 Bucket: " + f"{bucket_name}", "\n ","Tidal Job ID: " + TIDAL_JOB_ID)

-- COMMAND ----------

-- MAGIC %md #DDL

-- COMMAND ----------

-- MAGIC %md ##1. create backup table

-- COMMAND ----------

CREATE TABLE gms_us_hub.ref_materialmstr_plant_erp_glbl_bckup (
  ROW_KEY STRING,
  MATERIALMSTR_PLANT_KEY STRING,
  BUSINESS_KEY STRING,
  SRC_SYS_CD STRING,
  SITE_NM STRING,
  ABC_FLG STRING,
  BASE_UOM_NM STRING,
  ASMBL_SCRAP_PCT_VAL DECIMAL(23,3),
  TOTAL_LT_VAL DECIMAL(23,3),
  PROCUREMENT_TYPE_CD STRING,
  VALUATION_CLASS_DESC STRING,
  VALUATION_CLASS_VAL STRING,
  BATCH_SIZE_MAX_VAL DECIMAL(23,3),
  BATCH_SIZE_MIN_VAL DECIMAL(23,3),
  ROUND_VAL DECIMAL(23,3),
  DOSAGE_FORM_CD STRING,
  MAT_TYPE_CLUSTER_CD STRING,
  NORD_MAT_ID STRING,
  PROCURING_PLANT_ID STRING,
  REPLN_PLANT_ID STRING,
  REPLN_ENTITY_CD STRING,
  REPLICATION_FLG STRING,
  PROCURING_ENTITY_CD STRING,
  PROCURING_REGION_CD STRING,
  PROCURING_AREA_CD STRING,
  REPLN_REGION_CD STRING,
  REPLN_AREA_CD STRING,
  REGION_NM STRING,
  MRP_GROUP_CD STRING,
  PROD_PLAN_PLANT_ID STRING,
  SUPPLY_MODEL_CATG STRING,
  CTRY_ORIGIN_CD STRING,
  LOT_SIZE_KEY_CD STRING,
  SAFETY_STOCK_MIN_VAL DECIMAL(23,3),
  SCHED_MRGN_FLOAT_KEY_CD STRING,
  PLAN_TIME_FENCE_VAL STRING,
  SAFETY_STOCK_VAL DECIMAL(23,3),
  ISSUE_STORAGE_LOCATION_CD STRING,
  SERVICE_LVL_VAL DECIMAL(23,3),
  SOURCING_PLANT_SUPPLIER_CD STRING,
  LONG_TXT_DESC STRING,
  STOCK_LEVEL_MAX_VAL DECIMAL(23,3),
  SHELF_LIFE_REMAINING_MIN_VAL DECIMAL(23,3),
  REORDER_POINT_VAL DECIMAL(23,3),
  PLANT_SPECIFIC_MAT_STAT_CD STRING,
  PLANT_NM STRING,
  COVERAGE_PROF_CD STRING,
  SAFETY_TIME_FLG STRING,
  SAFETY_TIME_VAL BIGINT,
  PROCUREMENT_SERIAL_TYPE_CD STRING,
  CMDTY_FT_IMPORT_NUM STRING,
  QUOTA_ARGMT_USE_VAL STRING,
  PROD_PLAN_PLANT_2_ID STRING,
  SLS_PROD_CATG_10_CD STRING,
  SLS_PROD_CATG_7_CD STRING,
  SLS_PROD_CATG_9_CD STRING,
  CTRL_AREA_CD STRING,
  CMDTY_CLASS_CD STRING,
  CMDTY_SUB_CLASS_CD STRING,
  DEL_FLG STRING,
  MRP_TYPE_CD STRING,
  GR_PROC_TIME_VAL DECIMAL(23,3),
  GROUP_ITEM_DIM_CD STRING,
  GROUP_WH_PROC_1_CD STRING,
  GROUP_WH_PROC_2_CD STRING,
  GROUP_WH_PROC_3_CD STRING,
  IN_HOUSE_PROD_TIME_VAL DECIMAL(23,3),
  LOT_SIZE_VAL DECIMAL(23,3),
  MSTR_PLAN_FAMILY_CD STRING,
  MAT_ID STRING,
  MAT_POOL_CD STRING,
  MAT_SHORT_ID DECIMAL(38,0),
  MRP_CTRL_CD STRING,
  MAT_FREIGHT_GROUP_NM STRING,
  PLANT_ID STRING,
  PLND_DELIVERY_TIME_VAL DECIMAL(23,3),
  PROC_TIME_VAL DECIMAL(23,3),
  PROD_SCHED_CD STRING,
  PROFIT_CENTER_CD STRING,
  PURCHASING_GROUP_CD STRING,
  TOTAL_REPLN_LT_VAL DECIMAL(23,3),
  RUNOUT_DT STRING,
  SLS_PROD_CATG_3_CD STRING,
  SLS_PROD_CATG_4_CD STRING,
  SLS_PROD_CATG_5_CD STRING,
  SLS_PROD_CATG_1_CD STRING,
  SLS_PROD_CATG_2_CD STRING,
  SLS_PROD_CATG_6_CD STRING,
  SLS_PROD_CATG_8_CD STRING,
  SETUP_TIME_VAL DECIMAL(23,3),
  SHIP_PROC_TIME_VAL DECIMAL(23,3),
  STD_UOM_CONVERSION_NM STRING,
  MAX_STORAGE_PERIOD_UNIT_NM STRING,
  MAX_STORAGE_PERIOD_VAL DECIMAL(23,3),
  STOCK_TYPE_CD STRING,
  SUPPLIER_REBATE_CD STRING,
  INTEROPS_TIME_VAL DECIMAL(23,3),
  POTENCY_DESC STRING,
  MD5_KEY STRING,
  AUD_FILE_NM STRING,
  AUD_LD_DTS TIMESTAMP,
  AUD_UPD_DTS TIMESTAMP,
  AUD_LD_USR_ID STRING,
  AUD_LD_BTCH_ID BIGINT,
  AUD_SRC_SYS_ID STRING,
  ACTIVE_FLAG STRING)
USING delta
PARTITIONED BY (SRC_SYS_CD, SITE_NM)
LOCATION '${c.S3_ENV_PATH}/gms_us_hub/GMSGQ_DDM/ERP/ref_materialmstr_plant_erp_glbl_bckup'
TBLPROPERTIES (
  'Type' = 'EXTERNAL',
  'delta.minReaderVersion' = '1',
  'delta.minWriterVersion' = '2')

-- COMMAND ----------

-- MAGIC %md ##2. insert into backup table

-- COMMAND ----------

insert into gms_us_hub.ref_materialmstr_plant_erp_glbl_bckup (select * from gms_us_hub.ref_materialmstr_plant_erp_glbl )

-- COMMAND ----------

-- MAGIC %md ##3. Alter table add columns

-- COMMAND ----------

alter table
  gms_us_hub.ref_materialmstr_plant_erp_glbl
add
  columns (
    MRP_CTRL_DESC STRING
    AFTER
      POTENCY_DESC,
      MFG_LT_VAL decimal(38, 0)
    AFTER
      MRP_CTRL_DESC,
      ORD_POLICY_VAL decimal(38, 0)
    AFTER
      MFG_LT_VAL,
      ACCT_COST_QTY decimal(38, 0)
    AFTER
      ORD_POLICY_VAL
  )

-- COMMAND ----------

-- MAGIC %md ##4. Merge

-- COMMAND ----------

MERGE INTO gms_us_hub.ref_materialmstr_plant_erp_glbl TGT USING (
  SELECT
    t1.*,
    CAST(
      SHA2(
        CONCAT_WS(
          '-',
          COALESCE(t1.SRC_SYS_CD, ''),
          COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''),
          COALESCE(CAST(t1.PLANT_ID AS STRING), '')
        ),
        256
      ) AS STRING
    ) AS ROW_KEY,
    CAST(
      SHA2(
        CONCAT_WS(
          '-',
          COALESCE(t1.SRC_SYS_CD, ''),
          COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''),
          COALESCE(CAST(t1.PLANT_ID AS STRING), '')
        ),
        256
      ) AS STRING
    ) AS MATERIALMSTR_PLANT_KEY,
    CONCAT_WS(
      '-',
      COALESCE(t1.SRC_SYS_CD, ''),
      COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''),
      COALESCE(CAST(t1.PLANT_ID AS STRING), '')
    ) AS BUSINESS_KEY,
    MD5(
      CAST(
        Concat_ws(
          '-',
          COALESCE(CAST(t1.SLS_PROD_CATG_10_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.SLS_PROD_CATG_7_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.SLS_PROD_CATG_9_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.CMDTY_CLASS_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.CMDTY_SUB_CLASS_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.GROUP_ITEM_DIM_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.GROUP_WH_PROC_1_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.GROUP_WH_PROC_2_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.GROUP_WH_PROC_3_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.MSTR_PLAN_FAMILY_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.MAT_ID AS STRING), '*~+'),
          COALESCE(CAST(t1.MAT_POOL_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.MRP_CTRL_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.SLS_PROD_CATG_3_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.SLS_PROD_CATG_4_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.SLS_PROD_CATG_5_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.SLS_PROD_CATG_1_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.SLS_PROD_CATG_2_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.SLS_PROD_CATG_6_CD AS STRING), '*~+'),
          COALESCE (CAST(t1.SLS_PROD_CATG_8_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.STD_UOM_CONVERSION_NM AS STRING), '*~+'),
          COALESCE(CAST(t1.STOCK_TYPE_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.SUPPLIER_REBATE_CD AS STRING), '*~+'),
          COALESCE(CAST(t1.POTENCY_DESC AS STRING), '*~+'),
          COALESCE(CAST(t1.MRP_CTRL_DESC AS STRING), '*~+'),
          COALESCE(CAST(t1.MFG_LT_VAL AS STRING), '*~+'),
          COALESCE(CAST(t1.ORD_POLICY_VAL AS STRING), '*~+'),
          COALESCE(CAST(t1.ACCT_COST_QTY AS STRING), '*~+'),
          COALESCE(CAST(t1.ACTIVE_FLAG AS STRING), '*~+')
        ) AS BINARY
      )
    ) AS MD5_KEY
  FROM
    (
      SELECT
        DISTINCT 'JDE_C3ME' AS SRC_SYS_CD,
        cast(NULL AS STRING) AS SITE_NM,
        cast(NULL AS STRING) AS ABC_FLG,
        cast(NULL AS STRING) AS BASE_UOM_NM,
        cast(NULL AS DECIMAL(23, 3)) AS ASMBL_SCRAP_PCT_VAL,
        cast(NULL AS DECIMAL(23, 3)) AS TOTAL_LT_VAL,
        cast(NULL AS STRING) AS PROCUREMENT_TYPE_CD,
        cast(NULL AS STRING) AS VALUATION_CLASS_DESC,
        cast(NULL AS STRING) AS VALUATION_CLASS_VAL,
        cast(NULL AS DECIMAL(23, 3)) AS BATCH_SIZE_MAX_VAL,
        cast(NULL AS DECIMAL(23, 3)) AS BATCH_SIZE_MIN_VAL,
        cast(NULL AS DECIMAL(23, 3)) AS ROUND_VAL,
        cast(NULL AS STRING) AS DOSAGE_FORM_CD,
        cast(NULL AS STRING) AS MAT_TYPE_CLUSTER_CD,
        cast(NULL AS STRING) AS NORD_MAT_ID,
        cast(NULL AS STRING) AS PROCURING_PLANT_ID,
        cast(NULL AS STRING) AS REPLN_PLANT_ID,
        cast(NULL AS STRING) AS REPLN_ENTITY_CD,
        cast(NULL AS STRING) AS REPLICATION_FLG,
        cast(NULL AS STRING) AS PROCURING_ENTITY_CD,
        cast(NULL AS STRING) AS PROCURING_REGION_CD,
        cast(NULL AS STRING) AS PROCURING_AREA_CD,
        cast(NULL AS STRING) AS REPLN_REGION_CD,
        cast(NULL AS STRING) AS REPLN_AREA_CD,
        cast(NULL AS STRING) AS REGION_NM,
        cast(NULL AS STRING) AS MRP_GROUP_CD,
        cast(NULL AS STRING) AS PROD_PLAN_PLANT_ID,
        cast(NULL AS STRING) AS SUPPLY_MODEL_CATG,
        cast(NULL AS STRING) AS CTRY_ORIGIN_CD,
        cast(NULL AS STRING) AS LOT_SIZE_KEY_CD,
        cast(NULL AS DECIMAL(23, 3)) AS SAFETY_STOCK_MIN_VAL,
        cast(NULL AS STRING) AS SCHED_MRGN_FLOAT_KEY_CD,
        cast(NULL AS STRING) AS PLAN_TIME_FENCE_VAL,
        cast(NULL AS DECIMAL(23, 3)) AS SAFETY_STOCK_VAL,
        cast(NULL AS STRING) AS ISSUE_STORAGE_LOCATION_CD,
        cast(NULL AS DECIMAL(23, 3)) AS SERVICE_LVL_VAL,
        cast(NULL AS STRING) AS SOURCING_PLANT_SUPPLIER_CD,
        cast(NULL AS STRING) AS LONG_TXT_DESC,
        cast(NULL AS DECIMAL(23, 3)) AS STOCK_LEVEL_MAX_VAL,
        cast(NULL AS DECIMAL(23, 3)) AS SHELF_LIFE_REMAINING_MIN_VAL,
        cast(NULL AS DECIMAL(23, 3)) AS REORDER_POINT_VAL,
        cast(NULL AS STRING) AS PLANT_SPECIFIC_MAT_STAT_CD,
        cast(NULL AS STRING) AS PLANT_NM,
        cast(NULL AS STRING) AS COVERAGE_PROF_CD,
        cast(NULL AS STRING) AS SAFETY_TIME_FLG,
        cast(NULL AS BIGINT) AS SAFETY_TIME_VAL,
        cast(NULL AS STRING) AS PROCUREMENT_SERIAL_TYPE_CD,
        cast(NULL AS STRING) AS CMDTY_FT_IMPORT_NUM,
        cast(NULL AS STRING) AS QUOTA_ARGMT_USE_VAL,
        cast(NULL AS STRING) AS PROD_PLAN_PLANT_2_ID,
        cast(F4102.IBSRP0 AS STRING) AS SLS_PROD_CATG_10_CD,
        cast(F4102.IBSRP7 AS STRING) AS SLS_PROD_CATG_7_CD,
        cast(F4102.IBSRP9 AS STRING) AS SLS_PROD_CATG_9_CD,
        cast(NULL AS STRING) AS CTRL_AREA_CD,
        cast(F4102.IBPRP1 AS STRING) AS CMDTY_CLASS_CD,
        cast(F4102.IBPRP2 AS STRING) AS CMDTY_SUB_CLASS_CD,
        cast(NULL AS STRING) AS DEL_FLG,
        cast(NULL AS STRING) AS MRP_TYPE_CD,
        cast(NULL AS DECIMAL(23, 3)) AS GR_PROC_TIME_VAL,
        cast(F4102.IBPRP6 AS STRING) AS GROUP_ITEM_DIM_CD,
        cast(F4102.IBPRP7 AS STRING) AS GROUP_WH_PROC_1_CD,
        cast(F4102.IBPRP8 AS STRING) AS GROUP_WH_PROC_2_CD,
        cast(F4102.IBPRP9 AS STRING) AS GROUP_WH_PROC_3_CD,
        cast(NULL AS DECIMAL(23, 3)) AS IN_HOUSE_PROD_TIME_VAL,
        cast(NULL AS DECIMAL(23, 3)) AS LOT_SIZE_VAL,
        cast(F4102.IBPRP4 AS STRING) AS MSTR_PLAN_FAMILY_CD,
        cast(F4102.IBLITM AS STRING) AS MAT_ID,
        cast(F4102.IBPRP0 AS STRING) AS MAT_POOL_CD,
        cast(F4102.IBITM AS DECIMAL(38, 0)) AS MAT_SHORT_ID,
        cast(F4102.IBANPL AS STRING) AS MRP_CTRL_CD,
        cast(NULL AS STRING) AS MAT_FREIGHT_GROUP_NM,
        cast(F4102.IBMCU AS STRING) AS PLANT_ID,
        cast(NULL AS DECIMAL(23, 3)) AS PLND_DELIVERY_TIME_VAL,
        cast(NULL AS DECIMAL(23, 3)) AS PROC_TIME_VAL,
        cast(NULL AS STRING) AS PROD_SCHED_CD,
        cast(NULL AS STRING) AS PROFIT_CENTER_CD,
        cast(NULL AS STRING) AS PURCHASING_GROUP_CD,
        cast(NULL AS DECIMAL(23, 3)) AS TOTAL_REPLN_LT_VAL,
        cast(NULL AS STRING) AS RUNOUT_DT,
        cast(F4102.IBSRP3 AS STRING) AS SLS_PROD_CATG_3_CD,
        cast(F4102.IBSRP4 AS STRING) AS SLS_PROD_CATG_4_CD,
        cast(F4102.IBSRP5 AS STRING) AS SLS_PROD_CATG_5_CD,
        cast(F4102.IBSRP1 AS STRING) AS SLS_PROD_CATG_1_CD,
        cast(F4102.IBSRP2 AS STRING) AS SLS_PROD_CATG_2_CD,
        cast(F4102.IBSRP6 AS STRING) AS SLS_PROD_CATG_6_CD,
        cast(F4102.IBSRP8 AS STRING) AS SLS_PROD_CATG_8_CD,
        cast(NULL AS DECIMAL(23, 3)) AS SETUP_TIME_VAL,
        cast(NULL AS DECIMAL(23, 3)) AS SHIP_PROC_TIME_VAL,
        cast(F4102.IBTFLA AS STRING) AS STD_UOM_CONVERSION_NM,
        cast(NULL AS STRING) AS MAX_STORAGE_PERIOD_UNIT_NM,
        cast(NULL AS DECIMAL(23, 3)) AS MAX_STORAGE_PERIOD_VAL,
        cast(F4102.IBSTKT AS STRING) AS STOCK_TYPE_CD,
        cast(F4102.IBPRP3 AS STRING) AS SUPPLIER_REBATE_CD,
        cast(NULL AS DECIMAL(23, 3)) AS INTEROPS_TIME_VAL,
        cast(
          CONCAT (TRIM(F0005.DRDL01), F0005.DRDL02) AS STRING
        ) AS POTENCY_DESC,
        cast(F0101.ABALPH AS STRING) AS MRP_CTRL_DESC,
        cast(F4102.IBLTLV AS DECIMAL(38, 0)) AS MFG_LT_VAL,
        cast(F4102.IBOPV AS DECIMAL(38, 0)) AS ORD_POLICY_VAL,
        cast(F4102.IBACQ AS DECIMAL(38, 0)) AS ACCT_COST_QTY,
        cast(F4102.AUD_FILE_NM AS string) AS AUD_FILE_NM,
        cast(F4102.AUD_LD_DTS AS TIMESTAMP) AS AUD_LD_DTS,
        cast(F4102.AUD_UPD_DTS AS TIMESTAMP) AS AUD_UPD_DTS,
        cast('CDF_STREAMING' AS string) AS AUD_LD_USR_ID,
        cast(F4102.AUD_LD_BTCH_ID AS BIGINT) AS AUD_LD_BTCH_ID,
        cast('JDE_C3ME' AS string) AS AUD_SRC_SYS_ID,
        cast(F4102.ACTIVE_FLAG AS string) AS ACTIVE_FLAG
      FROM
        gms_us_lake.gmsgq_jde_proddta_f4102_adt F4102
        LEFT OUTER JOIN (
          SELECT
            DRKY,
            DRSY,
            DRRT,
            DRDL01,
            DRDL02
          FROM
            gms_us_lake.gmsgq_jde_prodctl_f0005
          WHERE
            TRIM(DRRT) = 'S5'
            AND TRIM(DRSY) = '41'
            AND ACTIVE_FLAG = 'Y'
        ) F0005 ON TRIM(F4102.IBSRP5) = TRIM(F0005.DRKY)
        LEFT OUTER JOIN (
          SELECT
            ABALPH,
            ABAN8
          FROM
            gms_us_lake.gmsgq_jde_proddta_f0101_adt
          WHERE
            ACTIVE_FLAG = 'Y'
        ) F0101 ON TRIM(F4102.IBANPL) = TRIM(F0101.ABAN8)
    ) t1
) STG ON tgt.ROW_KEY = stg.ROW_KEY AND STG.ACTIVE_FLAG = 'Y' 
WHEN MATCHED THEN
UPDATE
SET
  tgt.MD5_KEY = stg.MD5_KEY,
  tgt.MRP_CTRL_DESC = stg.MRP_CTRL_DESC,
  tgt.MFG_LT_VAL = stg.MFG_LT_VAL,
  tgt.ORD_POLICY_VAL = stg.ORD_POLICY_VAL,
  tgt.ACCT_COST_QTY = stg.ACCT_COST_QTY

-- COMMAND ----------

-- MAGIC %md #DML

-- COMMAND ----------

-- MAGIC %md
-- MAGIC ##5. insert into config table

-- COMMAND ----------

Update gms_us_hub.gmsgq_laketohub_streaming_config
set src_select_logic_sql = "SELECT t1.*, CAST( SHA2( CONCAT_WS( '-', COALESCE(t1.SRC_SYS_CD, ''), COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''), COALESCE(CAST(t1.PLANT_ID AS STRING), '') ), 256 ) AS STRING ) AS ROW_KEY, CAST( SHA2( CONCAT_WS( '-', COALESCE(t1.SRC_SYS_CD, ''), COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''), COALESCE(CAST(t1.PLANT_ID AS STRING), '') ), 256 ) AS STRING ) AS MATERIALMSTR_PLANT_KEY, CONCAT_WS( '-', COALESCE(t1.SRC_SYS_CD, ''), COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''), COALESCE(CAST(t1.PLANT_ID AS STRING), '') ) AS BUSINESS_KEY, MD5( CAST( Concat_ws( '-', COALESCE(CAST(t1.SLS_PROD_CATG_10_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_7_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_9_CD AS STRING), '*~+'), COALESCE(CAST(t1.CMDTY_CLASS_CD AS STRING), '*~+'), COALESCE(CAST(t1.CMDTY_SUB_CLASS_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_ITEM_DIM_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_WH_PROC_1_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_WH_PROC_2_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_WH_PROC_3_CD AS STRING), '*~+'), COALESCE(CAST(t1.MSTR_PLAN_FAMILY_CD AS STRING), '*~+'), COALESCE(CAST(t1.MAT_ID AS STRING), '*~+'), COALESCE(CAST(t1.MAT_POOL_CD AS STRING), '*~+'), COALESCE(CAST(t1.MRP_CTRL_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_3_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_4_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_5_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_1_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_2_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_6_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_8_CD AS STRING), '*~+'), COALESCE(CAST(t1.STD_UOM_CONVERSION_NM AS STRING), '*~+'), COALESCE(CAST(t1.STOCK_TYPE_CD AS STRING), '*~+'), COALESCE(CAST(t1.SUPPLIER_REBATE_CD AS STRING), '*~+'), COALESCE(CAST(t1.POTENCY_DESC AS STRING), '*~+'), COALESCE(CAST(t1.MRP_CTRL_DESC AS STRING), '*~+'), COALESCE(CAST(t1.MFG_LT_VAL AS STRING), '*~+'), COALESCE(CAST(t1.ORD_POLICY_VAL AS STRING), '*~+'), COALESCE(CAST(t1.ACCT_COST_QTY AS STRING), '*~+'), COALESCE(CAST(t1.ACTIVE_FLAG AS STRING), '*~+') ) AS BINARY ) ) AS MD5_KEY FROM ( SELECT DISTINCT 'JDE_C3ME' AS SRC_SYS_CD, cast(NULL AS STRING) AS SITE_NM, cast(NULL AS STRING) AS ABC_FLG, cast(NULL AS STRING) AS BASE_UOM_NM, cast(NULL AS DECIMAL(23, 3)) AS ASMBL_SCRAP_PCT_VAL, cast(NULL AS DECIMAL(23, 3)) AS TOTAL_LT_VAL, cast(NULL AS STRING) AS PROCUREMENT_TYPE_CD, cast(NULL AS STRING) AS VALUATION_CLASS_DESC, cast(NULL AS STRING) AS VALUATION_CLASS_VAL, cast(NULL AS DECIMAL(23, 3)) AS BATCH_SIZE_MAX_VAL, cast(NULL AS DECIMAL(23, 3)) AS BATCH_SIZE_MIN_VAL, cast(NULL AS DECIMAL(23, 3)) AS ROUND_VAL, cast(NULL AS STRING) AS DOSAGE_FORM_CD, cast(NULL AS STRING) AS MAT_TYPE_CLUSTER_CD, cast(NULL AS STRING) AS NORD_MAT_ID, cast(NULL AS STRING) AS PROCURING_PLANT_ID, cast(NULL AS STRING) AS REPLN_PLANT_ID, cast(NULL AS STRING) AS REPLN_ENTITY_CD, cast(NULL AS STRING) AS REPLICATION_FLG, cast(NULL AS STRING) AS PROCURING_ENTITY_CD, cast(NULL AS STRING) AS PROCURING_REGION_CD, cast(NULL AS STRING) AS PROCURING_AREA_CD, cast(NULL AS STRING) AS REPLN_REGION_CD, cast(NULL AS STRING) AS REPLN_AREA_CD, cast(NULL AS STRING) AS REGION_NM, cast(NULL AS STRING) AS MRP_GROUP_CD, cast(NULL AS STRING) AS PROD_PLAN_PLANT_ID, cast(NULL AS STRING) AS SUPPLY_MODEL_CATG, cast(NULL AS STRING) AS CTRY_ORIGIN_CD, cast(NULL AS STRING) AS LOT_SIZE_KEY_CD, cast(NULL AS DECIMAL(23, 3)) AS SAFETY_STOCK_MIN_VAL, cast(NULL AS STRING) AS SCHED_MRGN_FLOAT_KEY_CD, cast(NULL AS STRING) AS PLAN_TIME_FENCE_VAL, cast(NULL AS DECIMAL(23, 3)) AS SAFETY_STOCK_VAL, cast(NULL AS STRING) AS ISSUE_STORAGE_LOCATION_CD, cast(NULL AS DECIMAL(23, 3)) AS SERVICE_LVL_VAL, cast(NULL AS STRING) AS SOURCING_PLANT_SUPPLIER_CD, cast(NULL AS STRING) AS LONG_TXT_DESC, cast(NULL AS DECIMAL(23, 3)) AS STOCK_LEVEL_MAX_VAL, cast(NULL AS DECIMAL(23, 3)) AS SHELF_LIFE_REMAINING_MIN_VAL, cast(NULL AS DECIMAL(23, 3)) AS REORDER_POINT_VAL, cast(NULL AS STRING) AS PLANT_SPECIFIC_MAT_STAT_CD, cast(NULL AS STRING) AS PLANT_NM, cast(NULL AS STRING) AS COVERAGE_PROF_CD, cast(NULL AS STRING) AS SAFETY_TIME_FLG, cast(NULL AS BIGINT) AS SAFETY_TIME_VAL, cast(NULL AS STRING) AS PROCUREMENT_SERIAL_TYPE_CD, cast(NULL AS STRING) AS CMDTY_FT_IMPORT_NUM, cast(NULL AS STRING) AS QUOTA_ARGMT_USE_VAL, cast(NULL AS STRING) AS PROD_PLAN_PLANT_2_ID, cast(F4102.IBSRP0 AS STRING) AS SLS_PROD_CATG_10_CD, cast(F4102.IBSRP7 AS STRING) AS SLS_PROD_CATG_7_CD, cast(F4102.IBSRP9 AS STRING) AS SLS_PROD_CATG_9_CD, cast(NULL AS STRING) AS CTRL_AREA_CD, cast(F4102.IBPRP1 AS STRING) AS CMDTY_CLASS_CD, cast(F4102.IBPRP2 AS STRING) AS CMDTY_SUB_CLASS_CD, cast(NULL AS STRING) AS DEL_FLG, cast(NULL AS STRING) AS MRP_TYPE_CD, cast(NULL AS DECIMAL(23, 3)) AS GR_PROC_TIME_VAL, cast(F4102.IBPRP6 AS STRING) AS GROUP_ITEM_DIM_CD, cast(F4102.IBPRP7 AS STRING) AS GROUP_WH_PROC_1_CD, cast(F4102.IBPRP8 AS STRING) AS GROUP_WH_PROC_2_CD, cast(F4102.IBPRP9 AS STRING) AS GROUP_WH_PROC_3_CD, cast(NULL AS DECIMAL(23, 3)) AS IN_HOUSE_PROD_TIME_VAL, cast(NULL AS DECIMAL(23, 3)) AS LOT_SIZE_VAL, cast(F4102.IBPRP4 AS STRING) AS MSTR_PLAN_FAMILY_CD, cast(F4102.IBLITM AS STRING) AS MAT_ID, cast(F4102.IBPRP0 AS STRING) AS MAT_POOL_CD, cast(F4102.IBITM AS DECIMAL(38, 0)) AS MAT_SHORT_ID, cast(F4102.IBANPL AS STRING) AS MRP_CTRL_CD, cast(NULL AS STRING) AS MAT_FREIGHT_GROUP_NM, cast(F4102.IBMCU AS STRING) AS PLANT_ID, cast(NULL AS DECIMAL(23, 3)) AS PLND_DELIVERY_TIME_VAL, cast(NULL AS DECIMAL(23, 3)) AS PROC_TIME_VAL, cast(NULL AS STRING) AS PROD_SCHED_CD, cast(NULL AS STRING) AS PROFIT_CENTER_CD, cast(NULL AS STRING) AS PURCHASING_GROUP_CD, cast(NULL AS DECIMAL(23, 3)) AS TOTAL_REPLN_LT_VAL, cast(NULL AS STRING) AS RUNOUT_DT, cast(F4102.IBSRP3 AS STRING) AS SLS_PROD_CATG_3_CD, cast(F4102.IBSRP4 AS STRING) AS SLS_PROD_CATG_4_CD, cast(F4102.IBSRP5 AS STRING) AS SLS_PROD_CATG_5_CD, cast(F4102.IBSRP1 AS STRING) AS SLS_PROD_CATG_1_CD, cast(F4102.IBSRP2 AS STRING) AS SLS_PROD_CATG_2_CD, cast(F4102.IBSRP6 AS STRING) AS SLS_PROD_CATG_6_CD, cast(F4102.IBSRP8 AS STRING) AS SLS_PROD_CATG_8_CD, cast(NULL AS DECIMAL(23, 3)) AS SETUP_TIME_VAL, cast(NULL AS DECIMAL(23, 3)) AS SHIP_PROC_TIME_VAL, cast(F4102.IBTFLA AS STRING) AS STD_UOM_CONVERSION_NM, cast(NULL AS STRING) AS MAX_STORAGE_PERIOD_UNIT_NM, cast(NULL AS DECIMAL(23, 3)) AS MAX_STORAGE_PERIOD_VAL, cast(F4102.IBSTKT AS STRING) AS STOCK_TYPE_CD, cast(F4102.IBPRP3 AS STRING) AS SUPPLIER_REBATE_CD, cast(NULL AS DECIMAL(23, 3)) AS INTEROPS_TIME_VAL, cast( CONCAT(TRIM(F0005.DRDL01), F0005.DRDL02) AS STRING ) AS POTENCY_DESC, cast(F0101.ABALPH AS STRING) AS MRP_CTRL_DESC, cast(F4102.IBLTLV AS decimal(38, 0)) AS MFG_LT_VAL, cast(F4102.IBOPV AS decimal(38, 0)) AS ORD_POLICY_VAL, cast(F4102.IBACQ AS decimal(38, 0)) AS ACCT_COST_QTY, cast(F4102.AUD_FILE_NM AS string) AS AUD_FILE_NM, cast(F4102.AUD_LD_DTS AS TIMESTAMP) AS AUD_LD_DTS, cast(F4102.AUD_UPD_DTS AS TIMESTAMP) AS AUD_UPD_DTS, cast('CDF_STREAMING' AS string) AS AUD_LD_USR_ID, cast(F4102.AUD_LD_BTCH_ID AS BIGINT) AS AUD_LD_BTCH_ID, cast('JDE_C3ME' AS string) AS AUD_SRC_SYS_ID, cast(F4102.ACTIVE_FLAG AS string) AS ACTIVE_FLAG FROM gms_us_lake.gmsgq_jde_proddta_f4102_adt F4102 LEFT OUTER JOIN ( SELECT DRKY, DRSY, DRRT, DRDL01, DRDL02 FROM gms_us_lake.gmsgq_jde_prodctl_f0005 WHERE TRIM(DRRT) = 'S5' AND TRIM(DRSY) = '41' AND ACTIVE_FLAG = 'Y' ) F0005 ON TRIM(F4102.IBSRP5) = TRIM(F0005.DRKY) LEFT OUTER JOIN ( SELECT ABALPH, ABAN8 FROM gms_us_lake.gmsgq_jde_proddta_f0101_adt WHERE ACTIVE_FLAG = 'Y' ) F0101 ON TRIM(F4102.IBANPL) = TRIM(F0101.ABAN8) ) t1",
batch_sql_query = "SELECT t1.*, CAST( SHA2( CONCAT_WS( '-', COALESCE(t1.SRC_SYS_CD, ''), COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''), COALESCE(CAST(t1.PLANT_ID AS STRING), '') ), 256 ) AS STRING ) AS ROW_KEY, CAST( SHA2( CONCAT_WS( '-', COALESCE(t1.SRC_SYS_CD, ''), COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''), COALESCE(CAST(t1.PLANT_ID AS STRING), '') ), 256 ) AS STRING ) AS MATERIALMSTR_PLANT_KEY, CONCAT_WS( '-', COALESCE(t1.SRC_SYS_CD, ''), COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''), COALESCE(CAST(t1.PLANT_ID AS STRING), '') ) AS BUSINESS_KEY, MD5( CAST( Concat_ws( '-', COALESCE(CAST(t1.SLS_PROD_CATG_10_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_7_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_9_CD AS STRING), '*~+'), COALESCE(CAST(t1.CMDTY_CLASS_CD AS STRING), '*~+'), COALESCE(CAST(t1.CMDTY_SUB_CLASS_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_ITEM_DIM_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_WH_PROC_1_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_WH_PROC_2_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_WH_PROC_3_CD AS STRING), '*~+'), COALESCE(CAST(t1.MSTR_PLAN_FAMILY_CD AS STRING), '*~+'), COALESCE(CAST(t1.MAT_ID AS STRING), '*~+'), COALESCE(CAST(t1.MAT_POOL_CD AS STRING), '*~+'), COALESCE(CAST(t1.MRP_CTRL_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_3_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_4_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_5_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_1_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_2_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_6_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_8_CD AS STRING), '*~+'), COALESCE(CAST(t1.STD_UOM_CONVERSION_NM AS STRING), '*~+'), COALESCE(CAST(t1.STOCK_TYPE_CD AS STRING), '*~+'), COALESCE(CAST(t1.SUPPLIER_REBATE_CD AS STRING), '*~+'), COALESCE(CAST(t1.POTENCY_DESC AS STRING), '*~+'), COALESCE(CAST(t1.MRP_CTRL_DESC AS STRING), '*~+'), COALESCE(CAST(t1.MFG_LT_VAL AS STRING), '*~+'), COALESCE(CAST(t1.ORD_POLICY_VAL AS STRING), '*~+'), COALESCE(CAST(t1.ACCT_COST_QTY AS STRING), '*~+'), COALESCE(CAST(t1.ACTIVE_FLAG AS STRING), '*~+') ) AS BINARY ) ) AS MD5_KEY FROM ( SELECT DISTINCT 'JDE_C3ME' AS SRC_SYS_CD, cast(NULL AS STRING) AS SITE_NM, cast(NULL AS STRING) AS ABC_FLG, cast(NULL AS STRING) AS BASE_UOM_NM, cast(NULL AS DECIMAL(23, 3)) AS ASMBL_SCRAP_PCT_VAL, cast(NULL AS DECIMAL(23, 3)) AS TOTAL_LT_VAL, cast(NULL AS STRING) AS PROCUREMENT_TYPE_CD, cast(NULL AS STRING) AS VALUATION_CLASS_DESC, cast(NULL AS STRING) AS VALUATION_CLASS_VAL, cast(NULL AS DECIMAL(23, 3)) AS BATCH_SIZE_MAX_VAL, cast(NULL AS DECIMAL(23, 3)) AS BATCH_SIZE_MIN_VAL, cast(NULL AS DECIMAL(23, 3)) AS ROUND_VAL, cast(NULL AS STRING) AS DOSAGE_FORM_CD, cast(NULL AS STRING) AS MAT_TYPE_CLUSTER_CD, cast(NULL AS STRING) AS NORD_MAT_ID, cast(NULL AS STRING) AS PROCURING_PLANT_ID, cast(NULL AS STRING) AS REPLN_PLANT_ID, cast(NULL AS STRING) AS REPLN_ENTITY_CD, cast(NULL AS STRING) AS REPLICATION_FLG, cast(NULL AS STRING) AS PROCURING_ENTITY_CD, cast(NULL AS STRING) AS PROCURING_REGION_CD, cast(NULL AS STRING) AS PROCURING_AREA_CD, cast(NULL AS STRING) AS REPLN_REGION_CD, cast(NULL AS STRING) AS REPLN_AREA_CD, cast(NULL AS STRING) AS REGION_NM, cast(NULL AS STRING) AS MRP_GROUP_CD, cast(NULL AS STRING) AS PROD_PLAN_PLANT_ID, cast(NULL AS STRING) AS SUPPLY_MODEL_CATG, cast(NULL AS STRING) AS CTRY_ORIGIN_CD, cast(NULL AS STRING) AS LOT_SIZE_KEY_CD, cast(NULL AS DECIMAL(23, 3)) AS SAFETY_STOCK_MIN_VAL, cast(NULL AS STRING) AS SCHED_MRGN_FLOAT_KEY_CD, cast(NULL AS STRING) AS PLAN_TIME_FENCE_VAL, cast(NULL AS DECIMAL(23, 3)) AS SAFETY_STOCK_VAL, cast(NULL AS STRING) AS ISSUE_STORAGE_LOCATION_CD, cast(NULL AS DECIMAL(23, 3)) AS SERVICE_LVL_VAL, cast(NULL AS STRING) AS SOURCING_PLANT_SUPPLIER_CD, cast(NULL AS STRING) AS LONG_TXT_DESC, cast(NULL AS DECIMAL(23, 3)) AS STOCK_LEVEL_MAX_VAL, cast(NULL AS DECIMAL(23, 3)) AS SHELF_LIFE_REMAINING_MIN_VAL, cast(NULL AS DECIMAL(23, 3)) AS REORDER_POINT_VAL, cast(NULL AS STRING) AS PLANT_SPECIFIC_MAT_STAT_CD, cast(NULL AS STRING) AS PLANT_NM, cast(NULL AS STRING) AS COVERAGE_PROF_CD, cast(NULL AS STRING) AS SAFETY_TIME_FLG, cast(NULL AS BIGINT) AS SAFETY_TIME_VAL, cast(NULL AS STRING) AS PROCUREMENT_SERIAL_TYPE_CD, cast(NULL AS STRING) AS CMDTY_FT_IMPORT_NUM, cast(NULL AS STRING) AS QUOTA_ARGMT_USE_VAL, cast(NULL AS STRING) AS PROD_PLAN_PLANT_2_ID, cast(F4102.IBSRP0 AS STRING) AS SLS_PROD_CATG_10_CD, cast(F4102.IBSRP7 AS STRING) AS SLS_PROD_CATG_7_CD, cast(F4102.IBSRP9 AS STRING) AS SLS_PROD_CATG_9_CD, cast(NULL AS STRING) AS CTRL_AREA_CD, cast(F4102.IBPRP1 AS STRING) AS CMDTY_CLASS_CD, cast(F4102.IBPRP2 AS STRING) AS CMDTY_SUB_CLASS_CD, cast(NULL AS STRING) AS DEL_FLG, cast(NULL AS STRING) AS MRP_TYPE_CD, cast(NULL AS DECIMAL(23, 3)) AS GR_PROC_TIME_VAL, cast(F4102.IBPRP6 AS STRING) AS GROUP_ITEM_DIM_CD, cast(F4102.IBPRP7 AS STRING) AS GROUP_WH_PROC_1_CD, cast(F4102.IBPRP8 AS STRING) AS GROUP_WH_PROC_2_CD, cast(F4102.IBPRP9 AS STRING) AS GROUP_WH_PROC_3_CD, cast(NULL AS DECIMAL(23, 3)) AS IN_HOUSE_PROD_TIME_VAL, cast(NULL AS DECIMAL(23, 3)) AS LOT_SIZE_VAL, cast(F4102.IBPRP4 AS STRING) AS MSTR_PLAN_FAMILY_CD, cast(F4102.IBLITM AS STRING) AS MAT_ID, cast(F4102.IBPRP0 AS STRING) AS MAT_POOL_CD, cast(F4102.IBITM AS DECIMAL(38, 0)) AS MAT_SHORT_ID, cast(F4102.IBANPL AS STRING) AS MRP_CTRL_CD, cast(NULL AS STRING) AS MAT_FREIGHT_GROUP_NM, cast(F4102.IBMCU AS STRING) AS PLANT_ID, cast(NULL AS DECIMAL(23, 3)) AS PLND_DELIVERY_TIME_VAL, cast(NULL AS DECIMAL(23, 3)) AS PROC_TIME_VAL, cast(NULL AS STRING) AS PROD_SCHED_CD, cast(NULL AS STRING) AS PROFIT_CENTER_CD, cast(NULL AS STRING) AS PURCHASING_GROUP_CD, cast(NULL AS DECIMAL(23, 3)) AS TOTAL_REPLN_LT_VAL, cast(NULL AS STRING) AS RUNOUT_DT, cast(F4102.IBSRP3 AS STRING) AS SLS_PROD_CATG_3_CD, cast(F4102.IBSRP4 AS STRING) AS SLS_PROD_CATG_4_CD, cast(F4102.IBSRP5 AS STRING) AS SLS_PROD_CATG_5_CD, cast(F4102.IBSRP1 AS STRING) AS SLS_PROD_CATG_1_CD, cast(F4102.IBSRP2 AS STRING) AS SLS_PROD_CATG_2_CD, cast(F4102.IBSRP6 AS STRING) AS SLS_PROD_CATG_6_CD, cast(F4102.IBSRP8 AS STRING) AS SLS_PROD_CATG_8_CD, cast(NULL AS DECIMAL(23, 3)) AS SETUP_TIME_VAL, cast(NULL AS DECIMAL(23, 3)) AS SHIP_PROC_TIME_VAL, cast(F4102.IBTFLA AS STRING) AS STD_UOM_CONVERSION_NM, cast(NULL AS STRING) AS MAX_STORAGE_PERIOD_UNIT_NM, cast(NULL AS DECIMAL(23, 3)) AS MAX_STORAGE_PERIOD_VAL, cast(F4102.IBSTKT AS STRING) AS STOCK_TYPE_CD, cast(F4102.IBPRP3 AS STRING) AS SUPPLIER_REBATE_CD, cast(NULL AS DECIMAL(23, 3)) AS INTEROPS_TIME_VAL, cast( CONCAT(TRIM(F0005.DRDL01), F0005.DRDL02) AS STRING ) AS POTENCY_DESC, cast(F0101.ABALPH AS STRING) AS MRP_CTRL_DESC, cast(F4102.IBLTLV AS decimal(38, 0)) AS MFG_LT_VAL, cast(F4102.IBOPV AS decimal(38, 0)) AS ORD_POLICY_VAL, cast(F4102.IBACQ AS decimal(38, 0)) AS ACCT_COST_QTY, cast(F4102.AUD_FILE_NM AS string) AS AUD_FILE_NM, cast(F4102.AUD_LD_DTS AS TIMESTAMP) AS AUD_LD_DTS, cast(F4102.AUD_UPD_DTS AS TIMESTAMP) AS AUD_UPD_DTS, cast('CDF_STREAMING' AS string) AS AUD_LD_USR_ID, cast(F4102.AUD_LD_BTCH_ID AS BIGINT) AS AUD_LD_BTCH_ID, cast('JDE_C3ME' AS string) AS AUD_SRC_SYS_ID, cast(F4102.ACTIVE_FLAG AS string) AS ACTIVE_FLAG FROM ( SELECT * FROM ( SELECT *, row_number() OVER ( PARTITION BY IBMCU, IBITM ORDER BY aud_upd_dts, aud_ld_dts DESC ) AS row_num FROM gms_us_lake.gmsgq_jde_proddta_f4102_adt ) WHERE row_num = 1 ) F4102 LEFT OUTER JOIN ( SELECT * FROM ( SELECT DRKY, DRSY, DRRT, CASE WHEN ACTIVE_FLAG = 'N' THEN NULL ELSE DRDL01 END AS DRDL01, CASE WHEN ACTIVE_FLAG = 'N' THEN NULL ELSE DRDL02 END AS DRDL02, AUD_UPD_DTS, AUD_LD_DTS, row_number() OVER ( PARTITION BY DRSY, DRRT, DRKY ORDER BY aud_upd_dts, aud_ld_dts DESC ) AS row_num FROM gms_us_lake.gmsgq_jde_prodctl_f0005 WHERE TRIM(DRRT) = 'S5' AND TRIM(DRSY) = '41' ) WHERE row_num = 1 ) F0005 ON TRIM(F4102.IBSRP5) = TRIM(F0005.DRKY) LEFT OUTER JOIN ( select * from ( SELECT ABAN8, CASE WHEN ACTIVE_FLAG = 'N' THEN NULL ELSE ABALPH END AS ABALPH, aud_upd_dts, aud_ld_dts, row_number() OVER ( PARTITION BY ABAN8, ABALPH ORDER BY aud_upd_dts, aud_ld_dts DESC ) AS row_num FROM gms_us_lake.gmsgq_jde_proddta_f0101_adt ) WHERE row_num = 1 ) F0101 ON TRIM(F4102.IBANPL) = TRIM(F0101.ABAN8) WHERE greatest( coalesce( F0005.AUD_UPD_DTS, F0005.AUD_LD_DTS, CAST('1100-12-12 11:59:59' AS TIMESTAMP) ), coalesce( F0101.AUD_UPD_DTS, F0101.AUD_LD_DTS, CAST('1100-12-12 11:59:59' AS TIMESTAMP) ) ) >= ( SELECT coalesce( batch_last_run_time, CAST('1900-01-01 00:00:00' AS TIMESTAMP) ) TS FROM gms_us_hub.gmsgq_laketohub_batch_job_log WHERE lower(tgt_tbl) = 'gms_us_hub.ref_materialmstr_plant_erp_glbl' AND src_system = 'JDE_C3ME' AND lower(src_tbl) = 'gms_us_lake.gmsgq_jde_proddta_f4102_adt' ) ) t1",
src_child_tables = "gms_us_lake.gmsgq_jde_prodctl_f0005,gms_us_lake.gmsgq_jde_proddta_f0101_adt"
where src_tbl = "gms_us_lake.gmsgq_jde_proddta_f4102_adt"  and tgt_tbl = "gms_us_hub.ref_materialmstr_plant_erp_glbl" 

-- COMMAND ----------

-- MAGIC %md
-- MAGIC ##2. insert into DDM reference table

-- COMMAND ----------

select * from gms_us_hub.gmsgq_laketohub_streaming_config where tgt_tbl =  "gms_us_hub.ref_materialmstr_plant_erp_glbl"
